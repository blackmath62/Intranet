{% extends 'base.html.twig' %}
{% block title %}
	{{ title }}
{% endblock %}
{% block body %}
	<div class="card collapsed-card card-info">
		<div class="card-header">
			<h3 class="card-title">
				<i class="icon fas fa-info-circle"></i>
				Info</h3>
			<div class="card-tools">
				<button type="button" class="btn btn-tool" data-card-widget="collapse">
					<i class="fas fa-minus"></i>
				</button>
			</div>
		</div>
		<!-- /.card-header -->
		<div class="card-body"></div>
	</div>


	<div class="row">
		<div class="col-md-12">
			<div class="card collapsed-card card-dark">
				<div class="card-header">
					<h3 class="card-title text-center">Emails d'envoi de la liste des chantiers à 10 jours et des chantiers dépassés</h3>
					<div class="card-tools">
						<button type="button" class="btn btn-tool" data-card-widget="collapse">
							<i class="fas fa-minus"></i>
						</button>
						<button type="button" class="btn btn-tool" data-card-widget="remove">
							<i class="fas fa-times"></i>
						</button>
					</div>
				</div>
				<!-- /.card-header -->
				<div class="card-body">
					{{ form_start(form)}}
					<div class="form-group d-flex flex-wrap">
						{{ form_widget(form.email) }}
						{{ form_widget(form.Ajouter)}}
					</div>
					{{ form_end(form)}}
					{% if listeMails %}
						<table id="example2" class="table table-bordered table-striped">
							<thead>
								<tr>
									<th class="text-center">
										<span>Email actuellement dans la liste</span>
									</th>
									<th class="text-center">
										<span>Action</span>
									</th>
								</tr>
							</thead>
							<tbody>
								{% for listeMail in listeMails %}
									<tr>
										<td class="text-center">
											<a class="text-center text-dark">{{ listeMail.email }}</a>
										</td>
										<td class="text-center">
											<a data-toggle="modal" data-target="#modal-default-{{listeMail.id}}" class="text-center btn btn-xl btn-danger">
												<i class="fas fa-trash-alt"></i>
											</a>
											<div class="modal fade" id="modal-default-{{listeMail.id}}">
												<div class="modal-dialog">
													<div class="modal-content">
														<div class="modal-header">
															<h4 class="modal-title">Voulez vous vraiment supprimer ce mail ?</h4>
															<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																<span aria-hidden="true">&times;</span>
															</button>
														</div>
														<div class="modal-body">
															<p>Cette action est irréversible !&hellip;</p>
														</div>
														<div class="modal-footer justify-content-between">
															<button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
															<a type="button" href='{{path('app_email_delete_redirect', {'id' : listeMail.id, 'route' : app.request.attributes.get('_route') } ) }}' class="btn btn-danger">Supprimer</a>
														</div>
													</div>
													<!-- /.modal-content -->
												</div>
												<!-- /.modal-dialog -->
											</div>
											<!-- /.modal -->
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
			<div class="card card-dark">
				<div class="card-header d-flex">
					<h2 class="card-title mr-auto p-2 col-4">Liste des numéros de piéces à ajouter</h2>
					<div class="p-2 col-6">
						{{ form_start(formAddPieces) }}
						{{ form_errors(formAddPieces.numPieceCmd) }}
						{{ form_widget(formAddPieces.numPieceCmd) }}
						{{ form_errors(formAddPieces.numPieceBL) }}
						{{ form_widget(formAddPieces.numPieceBL) }}
						{{ form_errors(formAddPieces.numPieceFacture) }}
						{{ form_widget(formAddPieces.numPieceFacture) }}
						{{ form_end(formAddPieces) }}
					</div>
				</div>
			</div>
		</div>

		<div class="col-12 col-sm-12">
			<div class="card card-dark card-tabs">
				<div class="card-header p-0 pt-1">
					<ul class="nav nav-tabs" id="custom-tabs-one-tab" role="tablist">
						<li class="nav-item">
							<a class="nav-link active" id="custom-tabs-one-liste-tab" data-toggle="pill" href="#custom-tabs-one-liste" role="tab" aria-controls="custom-tabs-one-liste" aria-selected="true">Liste</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" id="custom-tabs-one-calendar-tab" data-toggle="pill" href="#custom-tabs-one-calendar" role="tab" aria-controls="custom-tabs-one-calendar" aria-selected="false">Calendrier</a>
						</li>
					</ul>
				</div>
				<div class="card-body">
					<div class="tab-content" id="custom-tabs-one-tabContent">
						<div class="tab-pane fade show active" id="custom-tabs-one-liste" role="tabpanel" aria-labelledby="custom-tabs-one-liste-tab">


							<div class="col-md-12">
								<div class="card card-dark">
									<div class="card-header d-flex justify-content-between">
										{% if app.request.attributes.get('_route')  == 'app_conduite_de_travaux_me_ok' %}
											<h2 class="card-title">Liste des piéces clients traitées</h2>
										{% elseif app.request.attributes.get('_route')  == 'app_conduite_de_travaux_me_nok' %}
											<h2 class="card-title">Liste des piéces clients à traiter</h2>
										{% endif %}
										<div class='ml-auto'>
											{% if app.request.attributes.get('_route')  == 'app_conduite_de_travaux_me_ok' %}
												<a title='Piéces à alimentées avec des piéces jointes!' href="{{ path('app_conduite_de_travaux_me_nok') }}" class="btn btn-warning text-dark">
													<i class="fas fa-thumbs-down pr-2"></i>Voir les piéces à traitrer</a>
											{% else %}
												<a title='Metre à jour les données' href="{{ path('app_conduite_de_travaux_me_update') }}" class="btn btn-primary ">
													<i class="fas fa-redo-alt pr-2"></i>Mettre à jour</a>
												<a title='Piéces alimentées, beau travail !' href="{{ path('app_conduite_de_travaux_me_ok') }}" class="btn btn-success">
													<i class="fas fa-thumbs-up pr-2"></i>Voir les piéces traitées</a>
											{% endif %}

										</div>
									</div>
									<!-- /.card-header -->
									<div class="card-body">
										{% if pieces %}
											<table id="example1" class="table table-bordered table-striped">
												<thead>
													<tr>
														<th class="text-center">
															<span>Tiers</span>
														</th>
														<th class="text-center">
															<span>Adresse de livraison / par</span>
														</th>
														<th class="text-center">
															<span>Affaire</span>
														</th>
														<th class="text-center">
															<span>transport</span>
														</th>
														<th class="text-center">
															<span>Cmd</span>
														</th>
														<th class="text-center">
															<span>BL</span>
														</th>
														<th class="text-center">
															<span>Facture</span>
														</th>
														<th class="text-center">
															<span>Délai demandé</span>
														</th>
														<th class="text-center">
															<span>Délai accepté</span>
														</th>
														<th class="text-center">
															<span>Délai reporté</span>
														</th>
														<th class="text-center">
															<span>Date Début chantier</span>
														</th>
														<th class="text-center">
															<span>Date fin chantier</span>
														</th>
														<th class="text-center">
															<span>Etat</span>
														</th>
														<th class="text-center">
															<span>Durée</span>
														</th>
														<th class="text-center">
															<span>Actions</span>
														</th>
													</tr>
												</thead>
												<tbody>

													{% for piece in pieces %}
														<tr>
															<td class="text-center">
																<a class="text-dark">{{ piece.codeClient }}
																</a>
															</td>
														</tr>
													</br>
													<a class="text-dark">{{ piece.nom }}</a>
												</tbody>
											</td>
											<td class="text-center">
												<a class="text-dark">{{ piece.adresseLivraison}}
												</br>
												<small class='text-mute'>
													<cite>
														Saisie par
														{{ piece.saisiePar }}</cite>
												</small>
											</td>
										</a>
									</td>
									<td class="text-center">
										<a class="text-dark">{{ piece.affaire}}</a>
									</td>
									<td class="text-center">
										<a class="text-dark">{{ piece.modeDeTransport }}
											/
											{{ piece.op }}</a>
									</td>
									<td class="text-center">
										{% if piece.numCmd > 0 %}
											<a class="text-dark">{{ piece.numCmd}}
												du</a>
										</br>
										<a class="text-dark">{{ piece.dateCmd|date("Y/m/d") }}</a>
									{% endif %}
								</td>
								<td class="text-center">
									{% if piece.numeroBl > 0 %}
										<a class="text-dark">{{ piece.numeroBl}}
											du</a>
									</br>
									<a class="text-dark">{{ piece.dateBl|date("Y/m/d") }}</a>
								{% endif %}
							</td>
							<td class="text-center">
								{% if piece.numeroFacture > 0 %}
									<a class="text-dark">{{ piece.numeroFacture}}
										du</a>
								</br>
								<a class="text-dark">{{ piece.dateFacture|date("Y/m/d") }}</a>
							{% endif %}
						</td>
						<td class="text-center">
							{% if piece.delaiDemande %}
								<a class="text-dark">{{ piece.delaiDemande|date("d/m/Y") }}</a>
							{% endif %}
						</td>
						<td class="text-center">
							{% if piece.delaiAccepte %}
								<a class="text-dark">{{ piece.delaiAccepte|date("d/m/Y") }}</a>
							{% endif %}
						</td>
						<td class="text-center">
							{% if piece.delaiReporte %}
								<a class="text-dark">{{ piece.delaiReporte|date("d/m/Y") }}</a>
							{% endif %}
						</td>
						<td class="text-center">
							{% if piece.dateDebutChantier %}
								<a class="btn" style="background-color: {{ piece.backgroundColor }}; color: {{ piece.textColor }}" ;>{{ piece.dateDebutChantier|date("d-m-Y H:i") }}</a>
							{% endif %}
						</td>
						<td class="text-center">
							{% if piece.dateFinChantier %}
								<a class="btn" style="background-color: {{ piece.backgroundColor }}; color: {{ piece.textColor }}" ;>{{ piece.dateFinChantier|date("d-m-Y H:i") }}</a>
							{% endif %}
						</td>
						<td class="text-center">
							{% set color = 'success' %}
							{% if piece.etat == 'En attente' %}
								{% set color = 'warning text-dark' %}
								{% set icone = "fa fa-pause" %}
							{% elseif piece.etat == 'En cours' %}
								{% set color = 'primary text-white' %}
								{% set icone = "fa fa-spinner" %}
							{% elseif piece.etat == 'A finir' %}
								{% set color = 'secondary text-white' %}
								{% set icone = "fa fa-battery-half" %}
							{% elseif piece.etat == 'Termine' %}
								{% set color = 'success text-white' %}
								{% set icone = "fa fa-check" %}
							{% elseif piece.etat == 'Litige' %}
								{% set color = 'danger text-white' %}
								{% set icone = "fa fa-exclamation" %}
							{% endif %}

							<div class="btn-group">
								<a class="btn btn-{{ color}}">
									<i class="{{icone}}" aria-hidden="true"></i>
								</a>
								<div class="btn-group">
									<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"></button>
									<ul class="dropdown-menu">
										<li>
											<a class="dropdown-item" href='{{path('app_conduite_de_travaux_me_change_etat', {'id' : piece.entId, 'etat' : 'Litige' } ) }}'>Litige</a>
										</li>
										<li>
											<a class="dropdown-item" href='{{path('app_conduite_de_travaux_me_change_etat', {'id' : piece.entId, 'etat' : 'En attente' } ) }}'>En attente</a>
										</li>
										<li>
											<a class="dropdown-item" href='{{path('app_conduite_de_travaux_me_change_etat', {'id' : piece.entId, 'etat' : 'A finir' } ) }}'>A finir</a>
										</li>
										<li>
											<a class="dropdown-item" href='{{path('app_conduite_de_travaux_me_change_etat', {'id' : piece.entId, 'etat' : 'En cours' } ) }}'>En cours</a>
										</li>
										<li>
											<a class="dropdown-item" href='{{path('app_conduite_de_travaux_me_change_etat', {'id' : piece.entId, 'etat' : 'Termine' } ) }}'>Termine</a>
										</li>
									</ul>
								</div>
							</div>


						</td>
						<td class="text-center">
							{% if piece.dureeTravaux %}
								<a class="text-dark">{{ piece.dureeTravaux }}</a>
							{% endif %}

						</td>
						<td class="text-center">
							<a href='{{path('app_conduite_de_travaux_me_show', {'id' : piece.entId } ) }}' class="text-light btn btn-xl btn-info">
								<i class="fas fa-eye"></i>
							</a>
							{% if commentaires %}
								{% for commentaire in commentaires %}
									{% if commentaire.ident == piece.ident and commentaire.nbeCommentaires > 0  %}
										<i class="fa fa-comments text-secondary pr-2 pl-2">
											<span class="badge badge-info right">
												{{commentaire.nbeCommentaires}}
											</span>
										</i>
									{% endif %}
								{% endfor %}
							{% endif %}
							{% if piece.nbeDocs > 0 %}
								<i class="fa fa-paperclip text-secondary">
									<span class="badge badge-info right">
										{{piece.nbeDocs}}
									</span>
								</i>
							{% endif %}
						</td>
					</tr>
				{% endfor %}
			</tbody>
			<tfoot>
				<tr>
					<th class="text-center">
						<span>Tiers</span>
					</th>
					<th class="text-center">
						<span>Adresse de livraison / par</span>
					</th>
					<th class="text-center">
						<span>Affaire</span>
					</th>
					<th class="text-center">
						<span>transport</span>
					</th>
					<th class="text-center">
						<span>Cmd</span>
					</th>
					<th class="text-center">
						<span>BL</span>
					</th>
					<th class="text-center">
						<span>Facture</span>
					</th>
					<th class="text-center">
						<span>Délai demandé</span>
					</th>
					<th class="text-center">
						<span>Délai accepté</span>
					</th>
					<th class="text-center">
						<span>Délai reporté</span>
					</th>
					<th class="text-center">
						<span>Date Début chantier</span>
					</th>
					<th class="text-center">
						<span>Date fin chantier</span>
					</th>
					<th class="text-center">
						<span>Etat</span>
					</th>
					<th class="text-center">
						<span>Durée</span>
					</th>
					<th class="text-center">
						<span>Actions</span>
					</th>
				</tr>
			</tfoot>
		</tr>
	</tfoot>
</table>{% else %}
<h4 class="text-left text-dark">
	<i class="fas fa-info-circle pr-2 text-primary"></i>Aucunes pieces à traiter actuellement, Félicitation !</h4>{% endif %}</div></div></div></div><div class="tab-pane fade active" id="custom-tabs-one-calendar" role="tabpanel" aria-labelledby="custom-tabs-one-calendar-tab"><div><!-- THE CALENDAR --><div id="external-events"></div><div id="calendar"></div></div></div></div></div><!-- /.card --></div></div> </div>{% endblock %}{% block javascripts %} <script>$(function () {
$("#example1").DataTable({
"responsive": true,
"lengthChange": false,
"autoWidth": false,
"order": [
[0, "desc"]
],
"buttons": [
"copy",
"csv",
"excel",
"pdf",
"print",
"colvis"
]
}).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
$("#example3").DataTable({
"responsive": true,
"lengthChange": false,
"autoWidth": false,
"order": [
[0, "desc"]
],
"buttons": [
"copy",
"csv",
"excel",
"pdf",
"print",
"colvis"
]
}).buttons().container().appendTo('#example3_wrapper .col-md-6:eq(0)');
$('#example2').DataTable({
"paging": true,
"lengthChange": false,
"searching": false,
"ordering": false,
"info": true,
"autoWidth": false,
"responsive": true
});
});</script> <!-- fullCalendar --> <script>/* initialize the calendar
     -----------------------------------------------------------------*/
window.onload = () => {
let calendarElt = document.querySelector("#calendar")
let calendar = new FullCalendar.Calendar(calendarElt, {
weekNumbers: true, // numéro de semaine
weekNumberCalculation: "ISO",
initialView: 'dayGridMonth',
locale: 'fr',
timeZone: 'Europe/Paris',
headerToolbar: {
left: 'prev,next today',
center: 'title',
right: 'dayGridMonth,timeGridWeek,timeGridDay'
},
buttonText: {
today: 'Aujourd\'hui',
month: 'Mois',
day: 'Jour',
week: 'Semaine'
},
events: {{ data|raw }}
})
calendar.render()
};</script> <!-- End Calendrier --> <script>$(function () { // Initialize Select2 Elements
$('.select-Piece-Cmd').select2({
placeholder: "Saisissez les numéros de commandes",
tags: true,
tokenSeparators: [',', ' ']
}).on('change', function (e) {
let label = $(this).find("[data-select2-tag=true]");
if (label.length && $.inArray(label.val(), $(this).val() !== -1)) {
$.ajax({
url: "/Lhermitte/conduite/travaux/num/ajout/ajax/" + label.val() + "/2",
type: "POST"
}).done(function (data) {
console.log(data)
$('.select-Piece-Cmd').val('');
});
}

});

// Initialize Select2 Elements
$('.select2bs4').select2({theme: 'bootstrap4'})
})</script> <script>$(function () { // Initialize Select2 Elements
$('.select-Piece-BL').select2({
placeholder: "Saisissez les numéros de bls",
tags: true,
tokenSeparators: [',', ' ']
}).on('change', function (e) {
let label = $(this).find("[data-select2-tag=true]");
if (label.length && $.inArray(label.val(), $(this).val() !== -1)) {
$.ajax({
url: "/Lhermitte/conduite/travaux/num/ajout/ajax/" + label.val() + "/3",
type: "POST"
}).done(function (data) {
console.log(data)
$('.select-Piece-BL').val('');
});
}

});

// Initialize Select2 Elements
$('.select2bs4').select2({theme: 'bootstrap4'})
})</script> <script>$(function () { // Initialize Select2 Elements
$('.select-Piece-Facture').select2({
placeholder: "Saisissez les numéros de Factures",
tags: true,
tokenSeparators: [',', ' ']
}).on('change', function (e) {
let label = $(this).find("[data-select2-tag=true]");
if (label.length && $.inArray(label.val(), $(this).val() !== -1)) {
$.ajax({
url: "/Lhermitte/conduite/travaux/num/ajout/ajax/" + label.val() + "/4",
type: "POST"
}).done(function (data) {
console.log(data)
$('.select-Piece-Facture').val('');
});
}

});

// Initialize Select2 Elements
$('.select2bs4').select2({theme: 'bootstrap4'})
})</script>{% endblock %}
