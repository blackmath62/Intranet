{% extends 'base.html.twig' %}

{% block title %}Page des Tickets
{% endblock %}

{% block body %}
	<section class="content-header">

		<div class="card collapsed-card card-dark">
			<div class="card-header">
				<h3 class="card-title">Créer un nouveau ticket</h3>

				<div class="card-tools">
					<button type="button" class="btn btn-tool p-2" data-card-widget="collapse">
						<i class="fas fa-plus"></i>
					</button>
				</div>
			</div>
			{{ form_start(formTickets) }}

			<div class="card-body d-flex flex-wrap">
				<div class="form-group col-12">
					{{ form_widget(formTickets.title)}}
				</div>
				<div class="form-group col-12">
					<label>{{ form_label(formTickets.content) }}:</label>
					{{ form_widget(formTickets.content)}}
				</div>
				<div class="form-group col-2">
					<label>{{ form_label(formTickets.service) }}:</label>
					{{ form_widget(formTickets.service) }}
				</div>
				<div class="form-group col-2">
					<label>{{ form_label(formTickets.societe) }}:</label>
					{{ form_widget(formTickets.societe) }}
				</div>
				<div class="form-group col-2">
					<label>{{ form_label(formTickets.priority) }}:</label>
					{{ form_widget(formTickets.priority) }}
				</div>
				<div class="form-group col-3">
					<label>{{ form_label(formTickets.file) }}:</label>
					{{ form_widget(formTickets.file) }}
				</div>
				<div class="d-none">
					<label>{{ form_label(formTickets.statu) }}:</label>
					{{ form_widget(formTickets.statu) }}
				</div>

				<div class="form-group col-3 text-right">
					{{ form_row(formTickets.poster) }}
				</div>
			</div>
			{{ form_end(formTickets) }}
		</div>

		<!-- Control Sidebar -->
		<aside class="control-sidebar control-sidebar-dark"></aside>
		<!-- /.control-sidebar -->
		<!-- ./wrapper -->
		{% for statu in status %}
			{% set countTicketsByStatus = 0 %}
			{% for ticket in tickets if ticket.statu == statu %}
				{% set countTicketsByStatus = countTicketsByStatus + 1 %}
			{% endfor %}
			{% if countTicketsByStatus > 0 %}

				<!-- /.Création -->
				<div class="card">
					<div class="card-header" style="background-color: {{ statu.backgroundColor }}; color: {{ statu.textColor }}" ;>
						<h3 class="card-title">{{ statu.title }} <span class="badge badge-secondary right">{{ countTicketsByStatus }}</span></h3>
					</div>


					{% for ticket in tickets %}
						{% if ticket.statu == statu %}
							<div class="card collapsed-card card-light border m-2">
								<div class="card-header">
								
									<div class="d-flex ">
										<h2 class="card-title mr-auto p-2">
											<a href=" {{path('app_comment', {'id' : ticket.id} ) }}">Ticket {{ ticket.id }} : {{ ticket.title}}
											{% if ticket.prestataire %}
								<a class="btn btn-sm btn-info text-white">
								assigné à
								{{ticket.prestataire.nom}}</a>
							{% else %}
								<a class="btn btn-sm btn-danger text-white">pas encore assigné à un intervenant</a>
							{% endif %}</a>
										{% set countNotEmpty = 0 %}
										{% for comment in comments if comment.ticket.id == ticket.id %}
											{% set countNotEmpty = countNotEmpty + 1 %}
										{% endfor %}

										{% if countNotEmpty > 0 %}
											<a class="btn btn-sm" href=" {{path('app_comment', {'id' : ticket.id} ) }}">
												<i class="fas fa-comments"></i>
												<span class="badge bg-warning">{{ countNotEmpty }}</span>
											</a>
										{% endif %}
										</h2>
												<img class="img-fluid col-1" src="{{ ticket.societe.img }}">
										<div>
												<a class="btn btn-sm" style="background-color: {{ ticket.service.color }}; color: {{ ticket.service.textColor }}" ;>{{ ticket.service.title }}</a>
												<a class="btn btn-sm" style="background-color: {{ ticket.priority.color }}; color: {{ ticket.priority.textColor }}" ;>{{ ticket.priority.title }}</a>
											<h2 class="card-title p-2">
												{{ ticket.user.pseudo}}
												le
												{{ ticket.createdAt|date("d/m/Y")}}
												à
												{{ ticket.createdAt|date("H:i")}}
											</h2>
										</div>

										<div class="card-tools">
											<button type="button" class="btn btn-tool p-2" data-card-widget="collapse">
												<i class="fas fa-plus"></i>
											</button>
										</div>
									</div>
								</div>

								<div class="card-body">
									<div class="form-group col-12">
										<label for="exampleInputEmail1">Objet</label>
										<h3 type="text" name="objet" id="objet">{{ ticket.title}}</h3>
									</div>
									<div class='d-flex flex-wrap'>
										<div class="form-group col-2">
											<label for="exampleInputPassword1">Date ouverture</label>
											<div>{{ ticket.createdAt|date("d/m/Y")}}</div>
										</div>
										<div class="form-group col-2">
											<label for="exampleInputPassword1">Date clotûre</label>
											{% if  ticket.closedAt  %}
												<div>{{ ticket.closedAt|date("d/m/Y")}}</div>
											{% endif %}
										</div>
										<div class="form-group col-2">
											<label for="exampleInputPassword1">Service</label>
											<div>
												<a class="btn btn-xl" style="background-color: {{ ticket.service.color }}; color: {{ ticket.service.textColor }}" ;>{{ ticket.service.title }}</a>
											</div>
										</div>
										<div class="form-group col-2">
											<label for="exampleInputPassword1">Statut</label>
											<div>
												<a class="btn btn-xl" style="background-color: {{ ticket.statu.backgroundColor }}; color: {{ ticket.statu.textColor }}" ;>{{ ticket.statu.title }}</a>
											</div>
										</div>
										<div class="form-group col-2">
											<img class="img-fluid col-12" src="{{ ticket.societe.img }}">
										</div>
									</div>
									<div class="form-group col-12">
										<label for="exampleInputPassword1">Détail :
										</label>
										<article>{{ ticket.content|raw}}</article>
									</div>
									{% if ticket.file %}
										<div class="form-group col-12">
											<label>Fichiers joints :
											</label>
											<a href="{{ asset(asset('doc/tickets/' ~ ticket.file))}}" id="lien" name="lien" class="text-center btn btn-outline-info btn-xs">{{ ticket.file}}</a>
										</div>
									{% endif %}

									{% set countComments = 0 %}
									{% for comment in comments %}
										{% if comment.ticket.id == ticket.id %}
											{% set countComments = countComments + 1 %}
										{% endif %}
									{% endfor %}
									{% if countComments > 0 %}
										<div class="form-group">
											<h5>Commentaires :
											</h5>
										</div>
										
									{% endif %}

									<section class="content">
										<div class="container-fluid">
											<div class="row">
												<div class="col-md-12">
													<div class="timeline">
														{% for comment in comments %}
															<div>
																{% if comment.ticket.id == ticket.id %}
																	<i class="fas fa-comments bg-maroon"></i>
																	<div class="timeline-item">
																		<span class="time">{{ comment.CreatedAt|date("d/m/Y")}}
																			à
																			{{ comment.CreatedAt|date("H:i")}}</span>
																		<h3 class="timeline-header">Déposé par
																			{{ comment.user.pseudo }}</h3>
																		<h4 class="timeline-body">{{ comment.title|raw}}</h4>
																		<div class="timeline-body">{{ comment.content|raw}}</div>
																	</div>
																{% endif %}
															</div>
														{% endfor %}

														{% if countComments > 0 %}
															<div>
																<i class="fas fa-clock bg-gray"></i>
															</div>
														{% endif %}
													</div>
												</div>
											</div>
										</div>
									</section>
									<div class='row'>
										<div class="form-group mx-auto align-center">
											<a href=" {{path('app_comment', {'id' : ticket.id} ) }}" class="btn btn-dark">
												<i class="fas fa-comments mr-2"></i>
												Déposer un commentaire
											</a>
										</div>
									</div>

								</div>
							</div>
						{% endif %}
					{% endfor %}
				</div>
			{% endif %}
		{% endfor %}
	</section>
{% endblock %}
